<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stop Killing Games - ECI Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px 0;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 8px;
            color: #fff;
        }

        .stat-label {
            font-size: 1rem;
            opacity: 0.8;
            margin-bottom: 10px;
        }

        .stat-trend {
            font-size: 0.9rem;
            padding: 5px 10px;
            border-radius: 20px;
            display: inline-block;
        }

        .trend-positive {
            background: rgba(76, 175, 80, 0.3);
            color: #4CAF50;
        }

        .trend-negative {
            background: rgba(244, 67, 54, 0.3);
            color: #f44336;
        }

        .trend-neutral {
            background: rgba(158, 158, 158, 0.3);
            color: #9e9e9e;
        }

        .progress-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            border-radius: 15px;
            transition: width 0.5s ease;
            position: relative;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            height: 400px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
        }

        .loading::after {
            content: '';
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0%, 33% { content: '‚è≥ Loading'; }
            34%, 66% { content: '‚è≥ Loading.'; }
            67%, 100% { content: '‚è≥ Loading..'; }
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            border-radius: 25px;
            font-weight: bold;
            margin-top: 10px;
        }

        .status-on-track {
            background: rgba(76, 175, 80, 0.3);
            color: #4CAF50;
        }

        .status-behind {
            background: rgba(244, 67, 54, 0.3);
            color: #f44336;
        }

        .refresh-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50px;
            padding: 15px 20px;
            color: white;
            cursor: pointer;
            font-size: 1rem;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .last-updated {
            text-align: center;
            opacity: 0.7;
            margin-top: 20px;
            font-size: 0.9rem;
        }

        .emoji {
            font-size: 1.5em;
            margin-right: 8px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéÆ Stop Killing Games</h1>
            <p>European Citizens' Initiative Progress Tracker</p>
        </div>

        <div class="progress-section">
            <h2>üéØ Current Progress</h2>
            <div id="mainProgress" class="loading"></div>
        </div>

        <div class="stats-grid" id="statsGrid">
            <div class="loading"></div>
        </div>

        <div class="chart-container">
            <h3>üìà Signature Growth Trend</h3>
            <canvas id="trendChart" style="display: none;"></canvas>
            <div id="chartLoading" class="loading"></div>
        </div>

        <div class="last-updated" id="lastUpdated"></div>
    </div>

    <button class="refresh-btn" onclick="loadData()" title="Refresh Data">
        üîÑ Refresh
    </button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        let chart = null;
        
        // Configuration - Update this with your Railway app URL
        const API_BASE = window.location.origin; // Uses same domain as the dashboard
        
        async function fetchAPI(endpoint) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error(`Error fetching ${endpoint}:`, error);
                return null;
            }
        }

        function formatNumber(num) {
            return new Intl.NumberFormat().format(num);
        }

        function formatPercent(num) {
            return `${num.toFixed(1)}%`;
        }

        function getStatusEmoji(isOnTrack, trend) {
            if (isOnTrack) return trend === 'accelerating' ? 'üöÄ' : 'üü¢';
            return trend === 'slowing' ? 'üî¥' : '‚ö†Ô∏è';
        }

        function getTrendClass(trend) {
            if (trend === 'accelerating') return 'trend-positive';
            if (trend === 'slowing') return 'trend-negative';
            return 'trend-neutral';
        }

        async function loadMainProgress() {
            const latest = await fetchAPI('/latest');
            const performance = await fetchAPI('/performance');
            
            if (!latest) {
                document.getElementById('mainProgress').innerHTML = '‚ùå Failed to load progress data';
                return;
            }

            // Handle case where performance data might not be available yet
            const safePerformance = performance || {
                on_track_daily: null,
                velocity_trend: 'unknown',
                actual_per_day: null,
                daily_performance_ratio: null
            };

            const progressHtml = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap;">
                    <h3 style="font-size: 1.8rem;">${formatNumber(latest.signatures)} / ${formatNumber(latest.goal)} Signatures</h3>
                    <div class="status-indicator ${safePerformance.on_track_daily ? 'status-on-track' : safePerformance.on_track_daily === false ? 'status-behind' : 'trend-neutral'}" style="margin-top: 10px;">
                        ${getStatusEmoji(safePerformance.on_track_daily, safePerformance.velocity_trend)}
                        ${safePerformance.on_track_daily ? 'ON TRACK' : safePerformance.on_track_daily === false ? 'BEHIND SCHEDULE' : 'TRACKING'}
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${Math.min(latest.progress_percent, 100)}%"></div>
                    <div class="progress-text">${formatPercent(latest.progress_percent)}</div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 25px;">
                    <div style="text-align: center; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                        <strong style="color: #4CAF50;">üìÖ Days Remaining</strong><br>
                        <span style="font-size: 2.2em; font-weight: bold;">${latest.days_remaining || 'N/A'}</span>
                        ${latest.deadline ? `<br><small style="opacity: 0.8;">Until ${new Date(latest.deadline).toLocaleDateString()}</small>` : ''}
                    </div>
                    <div style="text-align: center; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                        <strong style="color: #2196F3;">üéØ Target Daily</strong><br>
                        <span style="font-size: 2.2em; font-weight: bold;">${latest.required_per_day ? formatNumber(Math.round(latest.required_per_day)) : 'N/A'}</span>
                        <br><small style="opacity: 0.8;">signatures needed</small>
                    </div>
                    <div style="text-align: center; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                        <strong style="color: ${safePerformance.on_track_daily ? '#4CAF50' : '#f44336'};">‚ö° Actual Daily</strong><br>
                        <span style="font-size: 2.2em; font-weight: bold; color: ${safePerformance.on_track_daily ? '#4CAF50' : '#f44336'}">
                            ${safePerformance.actual_per_day ? formatNumber(Math.round(safePerformance.actual_per_day)) : 'Calculating...'}
                        </span>
                        ${safePerformance.daily_performance_ratio ? 
                            `<br><small style="opacity: 0.8;">${(safePerformance.daily_performance_ratio * 100).toFixed(0)}% of target</small>` : ''}
                    </div>
                    <div style="text-align: center; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                        <strong style="color: #FF9800;">üöÄ Remaining</strong><br>
                        <span style="font-size: 2.2em; font-weight: bold;">${formatNumber(latest.goal - latest.signatures)}</span>
                        <br><small style="opacity: 0.8;">signatures to go</small>
                    </div>
                </div>
                
                <!-- Additional Progress Insights -->
                <div style="margin-top: 25px; padding: 20px; background: rgba(0,0,0,0.2); border-radius: 10px;">
                    <h4 style="margin-bottom: 15px; color: #fff;">üìä Progress Breakdown</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
                        <div>
                            <strong>Per Hour Target:</strong><br>
                            <span style="font-size: 1.3em;">${latest.required_per_hour ? Math.round(latest.required_per_hour) : 'N/A'}</span>
                        </div>
                        <div>
                            <strong>Per Minute Target:</strong><br>
                            <span style="font-size: 1.3em;">${latest.required_per_minute ? Math.round(latest.required_per_minute) : 'N/A'}</span>
                        </div>
                        <div>
                            <strong>Success Rate:</strong><br>
                            <span style="font-size: 1.3em; color: ${latest.progress_percent > 50 ? '#4CAF50' : '#FF9800'};">${formatPercent(latest.progress_percent)}</span>
                        </div>
                        <div>
                            <strong>Momentum:</strong><br>
                            <span style="font-size: 1.3em;">${safePerformance.velocity_trend || 'unknown'} ${safePerformance.velocity_trend === 'accelerating' ? 'üìà' : safePerformance.velocity_trend === 'slowing' ? 'üìâ' : '‚û°Ô∏è'}</span>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('mainProgress').innerHTML = progressHtml;
        }

        async function loadStats() {
            const performance = await fetchAPI('/performance');
            const stats = await fetchAPI('/history-stats');
            const trends = await fetchAPI('/trends?days=7');
            
            if (!performance && !stats) {
                document.getElementById('statsGrid').innerHTML = '<div class="loading">‚ùå Failed to load statistics</div>';
                return;
            }

            // Safe defaults
            const safePerformance = performance || {};
            const safeStats = stats || {};
            const safeTrends = trends || {};

            const statsHtml = `
                <div class="stat-card">
                    <div class="stat-number">${formatNumber(Math.round(safePerformance.actual_per_minute || 0))}</div>
                    <div class="stat-label">‚ö° Signatures per Minute</div>
                    <div class="stat-trend ${getTrendClass(safePerformance.velocity_trend)}">
                        ${safePerformance.velocity_trend || 'calculating...'}
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-number">${formatNumber(Math.round(safePerformance.actual_per_hour || 0))}</div>
                    <div class="stat-label">üìä Signatures per Hour</div>
                    <div class="stat-trend ${getTrendClass(safePerformance.velocity_trend)}">
                        ${safePerformance.velocity_trend || 'calculating...'}
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-number">${formatNumber(Math.round(safePerformance.actual_per_day || 0))}</div>
                    <div class="stat-label">üìà Signatures per Day</div>
                    <div class="stat-trend ${safePerformance.on_track_daily ? 'trend-positive' : safePerformance.on_track_daily === false ? 'trend-negative' : 'trend-neutral'}">
                        ${safePerformance.daily_performance_ratio ? 
                            `${(safePerformance.daily_performance_ratio * 100).toFixed(0)}% of target` : 
                            'Tracking performance'}
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-number">${formatNumber(Math.round(safePerformance.actual_per_week || 0))}</div>
                    <div class="stat-label">üóìÔ∏è Signatures per Week</div>
                    <div class="stat-trend trend-neutral">
                        Projected rate
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-number">${formatNumber(safeStats.total_growth || 0)}</div>
                    <div class="stat-label">üìä Total Growth</div>
                    <div class="stat-trend ${safeStats.momentum_score === 'positive' ? 'trend-positive' : 
                                              safeStats.momentum_score === 'negative' ? 'trend-negative' : 'trend-neutral'}">
                        ${safeStats.momentum_score || 'neutral'} momentum
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-number">${safeStats.total_entries || 0}</div>
                    <div class="stat-label">üìã Data Points</div>
                    <div class="stat-trend trend-neutral">
                        Since ${safeStats.first_entry ? new Date(safeStats.first_entry).toLocaleDateString() : 'start'}
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-number">${safeTrends.on_track_percentage ? Math.round(safeTrends.on_track_percentage) : 0}%</div>
                    <div class="stat-label">üéØ On Track Time</div>
                    <div class="stat-trend ${(safeTrends.on_track_percentage || 0) > 70 ? 'trend-positive' : 
                                              (safeTrends.on_track_percentage || 0) < 30 ? 'trend-negative' : 'trend-neutral'}">
                        Last 7 days
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-number">${formatNumber(Math.round(safeStats.average_signatures || 0))}</div>
                    <div class="stat-label">üìä Average Signatures</div>
                    <div class="stat-trend trend-neutral">
                        Historical average
                    </div>
                </div>
            `;
            
            document.getElementById('statsGrid').innerHTML = statsHtml;
        }

        async function loadChart() {
            const history = await fetchAPI('/history?limit=50');
            
            if (!history || !history.data || history.data.length === 0) {
                document.getElementById('chartLoading').innerHTML = '‚ùå No chart data available';
                return;
            }

            const ctx = document.getElementById('trendChart').getContext('2d');
            
            // Reverse data to show chronological order
            const data = history.data.reverse();
            
            const labels = data.map(d => new Date(d.timestamp).toLocaleDateString());
            const signatures = data.map(d => d.signatures);
            
            if (chart) {
                chart.destroy();
            }
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Signatures',
                        data: signatures,
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#4CAF50',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: 'white'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'white',
                                callback: function(value) {
                                    return formatNumber(value);
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'white'
                            }
                        }
                    },
                    elements: {
                        point: {
                            hoverRadius: 8
                        }
                    }
                }
            });
            
            document.getElementById('chartLoading').style.display = 'none';
            document.getElementById('trendChart').style.display = 'block';
        }

        async function loadData() {
            document.getElementById('lastUpdated').innerHTML = 'üîÑ Refreshing...';
            
            await Promise.all([
                loadMainProgress(),
                loadStats(),
                loadChart()
            ]);
            
            document.getElementById('lastUpdated').innerHTML = 
                `Last updated: ${new Date().toLocaleString()}`;
        }

        // Auto-refresh every 5 minutes
        setInterval(loadData, 5 * 60 * 1000);
        
        // Initial load
        loadData();
    </script>
</body>
</html>